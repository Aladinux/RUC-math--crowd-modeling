% vim:ft=tex
\section{Simulation approach}
\label{sec:simulation}
In this section, we describe how our simulation is implemented, and how the 
implementation works.

Our simulation is implemented in the Python programming language, with the 
calculation intensive parts implemented in C for performance reasons. We 
assume a virtual coordinate system using meters as a base unit, and with the 
origin in the centre of the area we simulate. Each pedestrian (or actor) is 
described by a centre point and a radius, and each wall is described by a line 
segment connecting two points.

All parameters are stored as double precision floating point values where 
nothing else is indicated. We use custom data structures to keep track of the 
actors and walls while running the simulation. Python is used to set up the 
initial conditions, run the program's main control loop, and draw the 
simulation results through the \emph{PyGame} library \cite{pygame}. This 
allows to do both real-time animation as well as saving each simulation step 
to be assembled into a film afterwards. All calculations and data processing 
is done in a Python extension written in C, to increase performance.

\subsection{Initial conditions and constants}
When initialising the model, parameters are set for each pedestrian. In the 
model, every parameter can vary between actors, while in practice many of them 
do not. In this section, we go through the parameters and how they are set.  
For all random numbers, the operating system's built-in random number 
generator is used and considered to be sufficient for our purposes. We run 
multiple simulations of the same initial conditions by fixing the seed of the 
random number generator to the same value for each run. Distributions are 
drawn by using the distribution functions of the \emph{NumPy} mathematical 
library for Python \cite{numpy}.

\subsubsection{Position related parameters}
There are a number of parameters that are set that has to do with the initial 
position of actors and walls. They are:

\begin{itemize}
    \item \textbf{Wall endpoints:} Points describing the endpoints of the 
        walls. These are set according to the scenario we want to simulate, so 
        in a square room with a single exit in the middle of a wall, there 
        will be five wall segments (one on each side of the exit, and one for 
        each of the other walls).

    \item \textbf{Actor positions:} Each actor has a starting position 
        distributed randomly within the room. These are created by drawing a 
        set of random numbers for the x and y coordinates respectively, and 
        adjusting the range of this random number to be within the room's 
        dimensions. Actor positions are adjusted so that they do not overlap 
        with the walls by adjusting coordinates so that the distance from the 
        center to each wall is at most the radius. This adjustment is not made 
        between actors, so they may overlap initially. It is assumed that the 
        model will correct this within the first few simulation steps, which 
        is also what we have seen in practice.

    \item \textbf{Actor radii:} The actor radii are drawn from a normal 
        distribution with a mean of $0,2$ meters and a standard deviation of 
        $0,01$ meters. This is done to simulate a natural variety in physical 
        stature of humans, and to avoid deadlocks caused by perfectly 
        symmetrical forces that might otherwise occur \cite{helbing00}.
        %TODO: Check this reference, maybe better explanation?
\end{itemize}

\subsubsection{Movement related parameters}
A number of parameters are set to control the movement of the actors. They 
are:

\begin{itemize}
    \item \textbf{Target:} Each actor has a target that they move towards. 
        This target is set outside the exit actors will move towards, and is 
        the same for all actors when there is only one exit. In situations 
        where there are multiple exits, actors are set to move towards one of 
        the exits at random, regardless of their position within the room. 
        Since the model does not deal with pathfinding, targets are not 
        changed during the simulation. When an actor reaches its target, it is 
        considered to have escaped, and is removed from the simulation.

    \item \textbf{Initial velocity:} This is set as both a vector and a scalar 
        representing vector length. The scalar speeds are drawn from a 
        normal distribution with a mean of $1.34$ and a standard deviation of 
        $0,26$. The initial velocity vectors are created by multiplying the 
        scalar speed with a normalised vector pointing from the actor's 
        initial position to the target.
        % TODO: Where do the mean and deviation come from?

    \item \textbf{Max speed:} TODO.

    \item \textbf{Desired velocity:} The desired velocity is the velocity the 
        actor wants to move at (see the explanation in 
        section~\ref{sec:the-model}). This is set equal to the initial velocity 
        under the assumption that when people start to leave a room they will 
        initially (try to) move at their desired velocity, and then be 
        affected by the model parameters once they start moving.

    \item \textbf{Relaxation time:} The relaxation time is the time it would 
        take an unhindered actor to return to their desired velocity after 
        having been hindered by something blocking their path. This is set to 
        one second for all actors.
        % TODO: Why one second, and is this explanation correct?

    \item \textbf{$\lambda$:} \cite{ABconstant} chose $\lambda$ $\approx 0.1$ to take into account
	anisotropic character of pedestrian interaction, such that the situations in front of
	a pedestrian have bigger impact on the pedestrians behaviour than things going on
	behind them. A larger $\lambda$ reflects a greater impact from behind.
\end{itemize}

\subsubsection{Constants}
The model includes a number of constants. These are parameters that do not 
vary between the agents, but are fixed for the whole simulation. They are:

\begin{itemize}
    \item \textbf{Timestep:} The timestep is the $\Delta T$ that passes for 
        each step of the simulation. As discussed in 
        section~ %TODO: Make new reference
		, there are various trade-offs in making 
        this parameter larger or smaller. We have experimented with different 
        values, and have found that a value of $0,01$ seconds make for a 
        simulation without errors such as jitter that results from larger 
        timestep values. Since setting the timestep corresponds to setting a 
        delta value for an Euler integration, there are various methods that 
        originate from this integration method, that might be used to vary the 
        timestep dynamically during the simulation. However, we have found 
        that with a fixed value of $0,01$ seconds, we get reasonable 
        performance of our simulation, so we have not found the need to 
        complicate our program by applying such methods.
        % TODO: Reference for dynamic timestep adjustment

    \item \textbf{$A$, $B$:} These values are given in \cite{ABconstant}. 
        Although the model allows for them to vary between agents, we have 
        (just as is done in the article) set them to a fixed value for the 
        whole simulation. The values given are $A=3,0$ and $B= 0,2$, where $ A $ indicates the strength of interaction and $ B $ reflects the range of interaction.
\end{itemize}

%The potential between pedestrian $\alpha$ and the wall $B$ is given by 

%\begin{equation}
%V_B=V_B^0 e^{-(r_\alpha - r_B^\alpha )/R} 
%\end{equation}
%where $V_B^0 = 10m^2s^{-2}$ and $R=0.2m$.
%These model parameters have been determined such that they are compatible with empirical data. 
%(Kilde: Dirk Helbing and Peter Molnar - Social force model for pedestrian dynamics). This is 
%the older article by Helbing, and it seems as if its the same initial conditions, as in 
%the article we are working with, except that the force between to pedestrians has changed. 
%But still I think we could use the old article to argue why these parameters 
%have the given values.\\

%\noindent
%$A^2_\alpha = 3m/s^2$ and $B^2_\alpha = 0.2 m\\$
%$A = 5 m/s^2$ and $B=0.1m$
%$r_{\alpha \beta} = 0.6m$
%$\lambda_a = 0.75$\\\\
%\noindent
%These values for the model have been calibrated with empirical data of pedestrian streams.
% TODO: What is this section doing here?

\subsection{The simulation steps}
The simulation is divided into two parts: Finding the accelerations (or 
resulting force) for all actors, and updating position and velocity for the 
actors.  Since the acceleration for each actor is dependent on both position 
and velocity of the other actors, splitting the calculations this way enables 
us to do the calculations of each actor in any order, and even parallel. The 
drawback is that the actors are only affected by the movement and positions of 
other actors as they were at the end of the last simulation step. This means 
that the time step has to be small enough that this does not matter in 
practice.

\subsubsection{Calculating the acceleration vectors}
The acceleration vectors for each actor, $\alpha$, is calculated as follows:

\begin{enumerate}
    \item Determine the acceleration vector provided by the actors' desired 
        direction of movement.
    \item For each other actor $\beta_1\dots\beta_n$, calculate the 
        acceleration vector provided by avoiding the actor $\beta_i$.
    \item Calculate acceleration vectors resulting from avoidance of the walls 
        $w_1\dots w_n$.
    \item Sum all the acceleration vectors to a resultant acceleration vector 
        $a$.
\end{enumerate}

Steps one to three correspond to the three parts of the model.
\subsubsection{Calculating the acceleration vector from the desired direction}
This acceleration comes from the difference between the desired velocity and 
actual velocity. While the desired velocity is calculated separately, it is 
composed of the length (desired speed) and the direction. The desired speed 
depends on the impatience factor $ \eta $, which comes from the average speed
 along the desired direction.

\subsubsection{Calculating the repulsion from other agents}
The repulsion is a product of two factors, the circular specification factor and
the angle dependence factor. The circular specification factor is an exponentially
growth function that depends on the distance and relative positions of
$ \alpha $ and $ \beta $.  The second factor depends on the angle between
the direction of motion and the vector pointing from other agent to the agent 
we are calculating.
 
 
\subsubsection{Calculating the repulsion from walls}
The calculation of repulsion from the walls is split in two parts for each 
actor: First all the points on the walls that will affect the actor is 
identified, then the repulsion from each point is calculated. As explained in 
section~\ref{sec:the-model}, the repulsion from the wall is measured from the 
nearest point of the wall to the actor. Identifying these points is done using 
the following algorithm:

\begin{enumerate}
    \item For each wall, calculate the projection of the vector pointing from 
        the wall's starting point to the actor, unto the vector pointing from 
        the wall's starting point to its endpoint.
        \begin{enumerate}
            \item If this point is part of the wall, save it to the list of points 
                repulsion should be calculated from, and add the wall's two endpoints 
                to the list of already used endpoints.

            \item If the projected point is not part of the wall, the endpoint closest 
                to the actor is used instead. This endpoint is saved to a 
                third list of endpoints repulsion should be calculated from.
        \end{enumerate}

    \item After having gone through all walls, for each point in the third 
        list, check if this point is already in the list of used endpoints. If 
        so, discard it. Otherwise, add it to the list of points repulsion 
        should be calculated from, and to the list of used endpoints.
\end{enumerate}

The algorithm starts out with the list of walls, and produces a list of points 
to calculate this repulsion from, ensuring that no wall endpoint is used 
twice. The points are then used as a basis for calculating the repulsion, as 
described in section~\ref{sec:the-model}.

\subsection{Updating position and velocity}
After every actor has been updated with a resulting acceleration vector from 
the current simulation step, all actors update their position and velocity.  
The position is updated by calculating a displacement vector as follows:

\begin{equation}
    \Delta p = (v_x \Delta t + \frac{1}{2}a_x \Delta t^2, v_y \Delta t + 
    \frac{1}{2}a_y \Delta t^2)
\end{equation}

Where $v_x$ and $v_y$ are the $x$ and $y$ components of the velocity vector, 
$a_x$ and $a_y$ are the $x$ and $y$ components of the acceleration vector, and 
$\Delta t$ is the time step.

After updating the position, the actor's velocity is updated by adding the 
acceleration vector, to be used for the next simulation step.

% start parameters: p_n, v_n for each person.
% p for each wall
%
% steps:
%
% for each person:
%   calculate acceleration from the force parts of the model
%
% for each person:
%   update position by displacement vector
%       delta-p = (v_x*delta-t+1/2*a_x*delta-t^2, 
%       v_y*delta-t+1/2*a_y*delta-t^2)
%   update velocity for next step
%
%
% initial parameters:
%   Set using some sort of distribution around a mean
%
%
% constants:
%   Where do they come from?

\subsection{Measurement of the concepts flow rate, density and efficiency}
As mentioned in section \ref{concepts}, we want to have some concepts we can use to compare
the simulations and to see if the simulations make sence.
In this section we will describe how we want to measure the concepts efficiency,
flow rate and density.

 \textbf{Efficiency}
	We will measure the efficiency throughout the simulations. The efficiency is a dimensionless number given by the average speed of each pedestrians divided by the desired speed of each pedestrian. In each time step it can be calculated as:
	\begin{equation}
		E_t=\frac{1}{N}\sum_{i=1}^{N}\frac{\overline{V_{\alpha}}}{V^0_{\alpha}}
	\end{equation}
	Where N is the number of pedestrians still left in the simulation(Since there is no reason to include pedestrians who have reach there desired point and therefore are not moving). 
	Then to find the efficiency for the entire simulation we then make a summation of $E_t$ for each time step and then divide with the number of simulation steps. So given as an equation we have
	\begin{equation}
		E=\frac{1}{T}\sum_{t=0}^{T}\frac{\overline{V}}{V^0_{\alpha}}
	\end{equation}
	Where T is the number os simulations step 



% \begin{itemize}
%     \item \textbf{Efficiency} The efficiency differs through the simulation since the
% 	    agents efficiency is high if the agents have no obstacles or pedestrians in front of them,
% 	    and drops when cloggings appear, because the agents actual velocity
% 	    drops due to the clogging in front of them.
% 	    Therefor we find it more interesting to measure the efficience when it is the lowest,
% 	    since that will say most about the simulation and the situation simulated.
% 	    Further more we want to measure the average efficiency of all the agents,
% 	    since we that will say more about the simulation than a single agent's efficiency.
% 	    To make the calculation as cheap as possible, we take the timestep with the lowest	
% 	    measured efficiency, and calculate the average efficiancy of all the pedestrians
% 	    and use that to compare with other simulations.
% 
%     \item \textbf{Flow rate} Part of the model geometry was made as a line seqment where we measure the average
% 	    flow rate and the maximum flow rate, as agents crossing the line seqment per second.
% 	    The time step length is 0.01 sec, so from simulation step no. 1 and up til simulation step no. 100, first interval, we sum up
% 	    the number of pedestrians who crossed the line seqment to get the flow rate within the first second of the simulation.
% 	    Then we do the same for the next 100 simulation steps, second interval, and subtract the number of pedestrians from the previous
% 	    interval. For each new interval we subtract the number of the pedestrians from previous intervals and so forth.
% 	    The maximum flow rate is then the interval with highest amount pedestrians crossing the seqment line.
% 	    For the average flowrate we divide the number of pedestrians used in the simulation with the total amount of simulation steps
% 	    it took for the last agent to cross the seqment line.
% 
% 	    In case one we implement the line seqment at the exit, so to measure flow rate as pedestrians exiting the room.
% 	    When the simulation starts agents first have to move to the exit before they can run out,
% 	    hence the lowest flow rate, 0 agents per second,
% 	    which would not give us any useful information, where as the highest flow rate tells us how many can exit the room per second.
% 	    In case two we implement the line seqment in the middle of the corridor to measure the flow rate in both the directions.
% 
% 	    In case two we 
% 	    
%     \item \textbf{Density} As part of the model geometry we made a square with the size $1 m^2$,
% 	    where we meaure the density as agents intersecting that square. We want to measure the highest density of all simulation steps
% 	    in the simulations, since this gives the most information of how dense the crowd was when exiting the room.
% 	    
% 	    In case one we place the square in front of the exit, and in case two we place on the line seqment in the middle of the corridor.
% 	    For saving calculations we only take the simulation step with the highest density.
% 	    As with the flow rate, the lowest density does not give us any useful information, since the all agents initial
% 	    positions possibly can be outside that sguare meter, in all simulations, then the density would in all our
% 	    simulations be 0 agents in that sguare meter.
% 
% 	    In case two
% \end{itemize}
% 
\subsection{Simulating our cases}
In this section we describe the geometrical features of our two cases, how many pedestrians we want in the simulations,
where the seqment line from which we measure the flow rate, the square used to measure the density and the describing the 
parameters used and how we want to modify them from simulation to simulation.

In case one we simulate agents leaving a squared room with the size 10 m x 10 m and with one exit with the size 1 m in the middle of
one of the wall seqments. The waypoint the agents are following is placed 3 meters from the exit outside the room.
The line seqment used to measure the flow rate is 2 m wide and placed outside the room with a distance of 0.3 m,
from the exit, to prevent that agents that are clogging are not measured more than one time.
The square used to measure the density has the size 2 m x 2 m, and is placed right in the room right in front of the exit.
We simulate the room with 100 pedestrians starting at random places and their initial velocity 0 m/s.
The agents desired velocity is Gaussian distributed around 1.36 m/s with a standard deviation of 0.26 m/s.
Maximum desired velocity is determined by multiplying the agents desired velocity with 1.3, so that the agents
maximum velocity and their desired velicity are linked.
$\lambda$ is initially set to 0.1, such that the agent are more influenced of what is going on in front of them.
The parameters A and B are set to respectively 2.2 and 0.2, and the relaxation time is set to 1.

In case two we simulate agents walking in both directions along a corridor of the size 50 m long and 4 m wide.
The agents are divided into two groups, each one starting in each end of the corridor, where the waypoint that the
left side group is following is placed 50 m behind the right end of the corridor. Correspondingsly the waypoint
the right side group is following is placed 50 m behind the left end of the corridor.
The seqment line we use to measure the flow rate with is placed in the middle of the corridor and is 4 m wide going from wall to wall.
The area used to measure the density is placed in the middle of the corridor, is 1 m long and 4 m wide and hence
also going from wall to wall.
In this simulation we start with 50 placed randomly on the right side of the line seqment used to measure the flow rate,
and 50 agents placed randomly on the left side of the line seqment.
The initial conditions are the same as in case one.
When the simulation has begun we do not want the simulation to stop when the agents have passed each other, therefore we
make two agent appear randomly on each half of the corridor each second in 60 second.

We want to simulate the two cases several times, where we vary one of the parameters at a time, to see if that improves the simulation,
in the sense that it looks more realistic, or that the flow rate, efficiency or density is the like of what \cite{self-org} simulated.
After the first simulation of each case with the initial conditions, we run some simulations where we change the parameter A and vary
it between 0.001 and 10.000.
Then we set A to the initial condition while we run some simulations where we change the parameter B and vary it between 0.001 and 10.000.
$\lambda$ is then varied between 0.100 and 1.000 while the other parameters are set to the initial conditions.
Some runs are made where $v^{max}_{\alpha}$ varies between 1.000 and 10.000.
The relaxation is varied between 0.100 and 10.000 and the timestep....
In case two we make some simulations where we vary the width of the door, between 0.700 and 1.000.

